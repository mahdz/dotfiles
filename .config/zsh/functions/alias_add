# function alias_add {
#
# Description:
#   Add or update an alias and immediately reload the aliases file.
#   Checks for existing aliases before adding and provides proper error handling.
#
# Usage:
#   alias_add <alias_name> <command>
#
# Arguments:
#   alias_name: Name of the alias to create
#   command: The command that the alias will execute
#
# Examples:
#   alias_add ll 'ls -la'
#   alias_add gp 'git push'
#
# Returns:
#   0 - Success
#   1 - Invalid arguments
#   2 - Failed to write to aliases file

    local name="$1" command="$2"
    local search_dirs=("${ZDOTDIR:-$HOME}" "${ZDOTDIR:-$HOME}/zshrc.d" "${ZSH_CUSTOM:-$ZDOTDIR/custom}/plugins/aliases")   # adjust as needed
    local aliases escaped_name qcmd

    if [[ -z "$name" || -z "$command" ]]; then
        echo "Usage: alias_add <name> <command>" >&2; return 1
    fi

    # Find up to 3 files with 'aliases' in the filename under search_dirs, pick the first match
    aliases=$(find "${search_dirs[@]}" -type f -iname '*aliases*' 2>/dev/null | head -n3 | head -n1)

    # If none found, fall back to default and create it
    if [[ -z "$aliases" ]]; then
        aliases="${ZDOTDIR:-$HOME}/.aliases"
        mkdir -p "$(dirname -- "$aliases")" 2>/dev/null || true
        : >"$aliases" 2>/dev/null || { echo "Cannot create $aliases" >&2; return 2; }
    fi

    # Escape alias name for grep (so regex metacharacters in $name are safe)
    escaped_name=$(printf '%s\n' "$name" | sed -e 's/[][^$.\/*+?(){}|\\]/\\&/g')

    # If alias exists, prompt to update and remove existing line (portable)
    if grep -q "^alias ${escaped_name}=" "$aliases" 2>/dev/null; then
        printf "Alias '%s' exists. Update? [y/N] " "$name"
        read -r resp
        [[ "$resp" =~ ^[Yy]$ ]] || { echo "Cancelled."; return 0; }
        awk -v n="$name" 'BEGIN{p="^alias " n "="} $0~p{next} {print}' "$aliases" >"${aliases}.tmp" && mv "${aliases}.tmp" "$aliases"
    fi

    # Append alias, escaping single quotes inside the command
    qcmd=$(printf '%s' "$command" | sed "s/'/'\\\\''/g")
    printf "alias %s='%s'\n" "$name" "$qcmd" >>"$aliases" || { echo "Write failed" >&2; return 2; }

    # Try to reload aliases (non-fatal)
    source "$aliases" 2>/dev/null || echo "Warning: failed to reload aliases" >&2

    echo "Added/updated $name in $aliases"
    return 0
# }


