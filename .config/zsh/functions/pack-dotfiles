#!/usr/bin/env zsh
# Dotfiles Configuration Summary Function

# Unset itself to avoid recursion (ignore if not defined)
  unfunction pack-dotfiles 2>/dev/null || true

__pack-dotfiles() {
  local output_file="${1:-$HOME/Desktop/dotfiles_settings_summary.txt}"
  local zdotdir="${ZDOTDIR:-$HOME/.config/zsh}"
  local -a dot_cmd=(git --git-dir="$HOME/.dotfiles" --work-tree="$HOME")
  local -i error_count=0
  local -a errors=()

  setopt local_options null_glob

  # Pre-flight checks with better error reporting
  if [[ ! -d "$zdotdir" ]]; then
    error "ZDOTDIR directory does not exist: $zdotdir"
    error "Please ensure your zsh configuration directory is properly set up"
    return 1
  fi

  local output_dir="${output_file:h}"
  if [[ ! -d "$output_dir" ]]; then
    if ! mkdir -p "$output_dir" 2>/dev/null; then
      error "Cannot create output directory: $output_dir"
      error "Please check permissions and disk space"
      return 1
    fi
  elif [[ ! -w "$output_dir" ]]; then
    error "Output directory is not writable: $output_dir"
    error "Please check permissions"
    return 1
  fi

  # Check if dotfiles git repo is accessible
  if ! "${dot_cmd[@]}" rev-parse --git-dir >/dev/null 2>&1; then
    warn "Dotfiles git repository not found or not accessible at $HOME/.dotfiles"
    warn "Some git-related information may be missing from the summary"
    (( error_count++ ))
    errors+=("dotfiles-git-repo")
  fi

  info "Creating dotfiles summary at: $output_file"

  _pack_append_file() {
    local file_path="$1"
    local is_critical="${2:-false}"

    if [[ -f "$file_path" ]]; then
        print "\n<file path=\"$file_path\">"
        cat "$file_path" || warn "Failed to read: $file_path"
        print '</file>'
    else
        warn "file missing: $file_path"
        if [[ "$is_critical" == "true" ]]; then
            (( error_count++ ))
            errors+=("missing-$file_path")
        fi
    fi
}


  {
    print "# Dotfile Configuration Summary"
    print "# Generated on: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
    print "# Hostname: $(hostname)"
    print "# Shell: $SHELL"
    print "# ZDOTDIR: $zdotdir"
    print "# Dotfiles Git SHA: $(${dot_cmd[@]} rev-parse --short HEAD 2>/dev/null || print 'N/A')"
    print ""

    print '\n<file path="global:git-config">'
    git config --global --list 2>/dev/null | sort || warn "# No global git config found"
    print '</file>'

    print '\n<file path="local:dotfiles-config">'
    "${dot_cmd[@]}" config --local --list 2>/dev/null | sort || warn "# No dotfiles git config found"
    print '</file>'

    local -a ignore_files=(
      "$HOME/.gitignore"
      "$HOME/.dotfiles/info/exclude"
      "$HOME/.config/git/ignore"
    )
    for file in "${ignore_files[@]}"; do
      _pack_append_file "$file"
    done

    print '\n<file path="dotfiles:untracked-directories">'
    "${dot_cmd[@]}" ls-files --others --exclude-standard --directory 2>/dev/null | sort || warn "# No untracked directories found"
    print '</file>'

    print '\n<!-- ZSH Configuration Files -->'

    local -a zsh_files=(
      "$HOME/.zshenv"
      "$zdotdir/.zshenv"
      "$HOME/.shellrc"
      "$zdotdir/.zprofile"
      "$zdotdir/.zstyles"
      "$zdotdir/.zsh_plugins.zsh"
      "$zdotdir/.zshrc"
    )

    if [[ -d "$zdotdir/lib" ]]; then
      local initial_count=${#zsh_files[@]}
      zsh_files+=("$zdotdir/lib/"*(N))
      info "Found lib directory with $((${#zsh_files[@]} - initial_count)) files"
    else
      warn "lib directory not found at $zdotdir/lib - this may indicate incomplete zsh setup"
      (( error_count++ ))
      errors+=("zsh-lib-missing")
    fi

    if [[ -d "$zdotdir/zshrc.d" ]]; then
      zsh_files+=("$zdotdir/zshrc.d/"*(N))
      info "Found zshrc.d directory with additional configuration files"
    else
      info "zshrc.d directory not found at $zdotdir/zshrc.d - optional directory"
    fi

    if [[ -d "$zdotdir/custom" ]]; then
      zsh_files+=("$zdotdir/custom/plugins/*/*.zsh"(N))
      info "Found custom plugins directory with configuration files"
    else
      warn "custom plugins directory not found at $zdotdir/custom - this may limit plugin functionality"
      (( error_count++ ))
      errors+=("zsh-custom-missing")
    fi

    for file in "${zsh_files[@]}"; do
      _pack_append_file "$file"
    done

    # Handle mise config with better error reporting
    local mise_config="$HOME/.config/mise/config.toml"
    if [[ -f "$mise_config" ]]; then
      print '\n<file path="$HOME/.config/mise/config.toml">'
      cat "$mise_config"
      print '</file>'
    else
      warn "Mise configuration file not found at $mise_config"
      (( error_count++ ))
      errors+=("mise-config-missing")
    fi

  } > "$output_file" || {
    error "Failed to write to output file: $output_file"
    error "Please check disk space and permissions"
    return 1
  }

  # Report final status with error summary
  if (( error_count == 0 )); then
    success "Configuration summary created successfully at $output_file"
  else
    warn "Configuration summary created at $output_file with $error_count issue(s)"
    for err in "${errors[@]}"; do
      warn "  - $err"
    done
  fi

  info "File size: $(du -h "$output_file" | cut -f1)"
  info "Line count: $(wc -l < "$output_file")"
}

# Load dependencies or environment if needed here
# Then call the real function with all passed arguments
__pack-dotfiles "$@"


# Setup completion for the lazy-loaded function (only if compdef is available)
(( ${+functions[compdef]} )) && compdef _files pack-dotfiles
