# ~/.config/mise/config.toml
# Global mise configuration (patched)
# Assumes: Homebrew-installed uv, zsh shell, and SOPS-managed secrets
# Notes:
#    - Prefer pinned versions for reproducibility; use 'latest' only for non-critical tools.
#    - post_install validation runs basic --version checks and smoke tests.
#    - Secrets paths normalized: .env.json, .env.dev, .env (hook checks .env)

[env]
# Path configurations
SECRETS_DIR = "$HOME/.local/share/secrets"
VENV_CACHE = "${XDG_DATA_HOME:-$HOME/.local/share}/venvs"
# Default package lists
MISE_PYTHON_DEFAULT_PACKAGES_FILE = "~/.config/mise/.default-python-packages"
MISE_NODE_DEFAULT_PACKAGES_FILE = "~/.config/mise/.default-npm-packages"
MISE_GO_DEFAULT_PACKAGES_FILE = "~/.config/mise/.default-go-packages"

# Load multiple secret files, redacted in logs
_.file = [
{ path = "$SECRETS_DIR/.env.json", redact = true },
{ path = "$SECRETS_DIR/.env.dev",   redact = true },
{ path = "$SECRETS_DIR/.env",       redact = true },
]

# [env.status]
# Controls per-env log output; keep false to avoid # leaking secrets to logs
# show_env = "false"

[hooks.enter]
shell = "zsh"
# Autoloaded function; only runs if the file exists
# Note: load-secrets must be idempotent and safe for interactive shells
script = "[ -f $SECRETS_DIR/.env ] && load-secrets"

[tools]
# npm MUST be first to prioritize standalone version over Node's bundled npm
npm = "11.6.2"

# Core runtimes (pin majors/minors when possible for reproducibility)
node = { version = "20.19.6" }   # prefer LTS major (adjust to tested minor if needed)
python = "3.13"
bun = "latest"                   # non-critical runtime; keep latest or pin as needed

# System utilities (pin critical CLIs; others may remain latest)
ripgrep = "latest"
shellcheck = "0.9.0"             # example pin; adjust if you tested a different version
gemini-cli = "latest"
pre-commit = "3.5.0"             # pin to a known stable release

# Node.js packages (grouped by function)
# Code formatting & linting
"npm:prettier" = "3.7.4"
"npm:markdownlint-cli" = "latest"

# Node.js utilities
"npm:npm-check" = "latest"
"npm:npkill" = "latest"

# AI/MCP tools (may have longer install times; keep pinned if dependent on native libs)
"npm:@motesoftware/nanocoder" = "latest"
"npm:@pimzino/agentic-tools-mcp" = "latest"

# Misc
"npm:resumed" = "latest"
"npm:jsonresume-theme-even" = "latest"

# Python CLI tools (managed via pipx backend with uvx=true)
# Comments: pin production-critical ones; leave experimental latest
"pipx:basic-memory" = "latest"
"pipx:psf/black" = "23.12.0"
"pipx:gallery-dl" = "latest"
"pipx:khard" = "latest"
"pipx:mac-cleanup" = "latest"
"pipx:osxmetadata" = "latest"
"pipx:rich-cli" = "latest"
"pipx:ruff" = "0.2.0"
"pipx:speedtest-cli" = "latest"
"pipx:yt-dlp" = "2025.11.12"
"pipx:twine" = "6.2.0"

[settings]
# Core settings
experimental = true
always_keep_download = false
always_keep_install = false
verbose = false                              # Set to true only for debugging (avoid in CI)
http_timeout = "60s"                         # Increase if network is slow
jobs = 4
cache_prune_age = "7d"                       # Increased from 3d to 7d for reliability
activate_aggressive = true
gix = false
python_compile = false
legacy_version_file = true
plugin_autoupdate_last_check_duration = "7d"

[settings.pipx]
uvx = true

[settings.python]
uv_venv_auto = true
uv_venv_create_args = ["--seed"]

[settings.status]
# UI-level env status display (kept true so tools show env in status UI)
# Note: [env.status].show_env=false prevents per-run env dumps in logs
show_env = false

# Post-install validation hook
# Ensure this script exists in a secure location within your repo (e.g., 99-meta/tools/scripts/mise-validate.sh)
[hooks.postinstall]
script = "~/.config/mise/hooks/mise-validate.sh"
# Optional: Provide a small timeout so the hook cannot hang indefinitely
timeout = "120s"
