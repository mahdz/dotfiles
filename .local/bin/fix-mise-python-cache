#!/bin/bash
# Fix mise Python cache git remote issue and upgrade mise tools

set -e  # Exit on error

PYENV_CACHE_DIR="$HOME/.cache/mise/python/pyenv"

# Function to fix Python cache
fix_python_cache() {
    if [ -d "$PYENV_CACHE_DIR/.git" ]; then
        cd "$PYENV_CACHE_DIR"
        if ! git remote get-url origin &>/dev/null; then
            echo "Adding missing git remote for mise Python cache..."
            git remote add origin https://github.com/pyenv/pyenv.git
            echo "Fixed!"
        else
            echo "Git remote already exists."
        fi
    else
        echo "Python cache directory not found or not a git repository."
    fi
}

# Function to upgrade mise with verbose output
upgrade_mise() {
    echo "Upgrading mise tools with verbose output..."
    if mise upgrade --verbose; then
        echo "‚úÖ All tools upgraded successfully!"
    else
        echo "‚ö†Ô∏è  Some tools failed to upgrade. Checking which tools are available..."
        echo "Current tool status:"
        mise list
        echo ""
        echo "You may need to:"
        echo "  1. Run 'mise reshim' to fix any shim issues"
        echo "  2. Manually update specific tools that failed"
        echo "  3. Check if aqua backend is properly configured"
        return 1
    fi
}

# Main execution
echo "üîß Fixing mise Python cache..."
fix_python_cache

echo ""
echo "üì¶ Upgrading mise tools..."
upgrade_mise
