#!/usr/bin/env zsh
# Task Migration Script for Unified Task Management System
#
# PURPOSE:
#   Migrates tasks from legacy FinFixer project structure to unified Obsidian Vault format
#   Preserves task content, status, and metadata during migration process
#
# WHAT IT DOES:
#   1. Creates timestamped backup of existing tasks
#   2. Converts FinFixer tasks to TASK-XXX-slug.md format
#   3. Preserves original content and adds migration metadata
#   4. Updates .gitignore to track new unified task structure
#   5. Regenerates task index for CLI integration
#
# SOURCE LOCATIONS:
#   - FinFixer tasks: /Users/mh/Developer/python/FinFixer/docs/tasks/
#     - active/ (maps to status: Active)
#     - completed/ (maps to status: Completed)
#     - backlog/ (maps to status: Planned)
#
# TARGET LOCATION:
#   - Unified tasks: $VAULT_PATH/02-Projects/TaskManager/tasks/
#
# USAGE:
#   ./migrate-tasks
#   (No arguments needed - script handles detection and migration automatically)
#
# SAFETY FEATURES:
#   - Creates timestamped backup before any changes
#   - Preserves original files (read-only operation on sources)
#   - Generates migration metadata and audit trail
#   - Dry-run capability built into backup creation
#
# INTEGRATION:
#   - Works with ~/bin/task CLI tool for unified task management
#   - Maintains global task ID sequence across all projects
#   - Compatible with Obsidian task management plugins
#
# STATUS CHECK:
#   Run 'ls -la /Users/mh/Developer/python/FinFixer/docs/tasks' to see pending tasks
#   Run 'find $VAULT_PATH/02-projects/tasks -name "*.md" | grep -i finfixer' for migrated tasks

set -euo pipefail

# Enable nullglob to handle empty glob patterns gracefully
setopt nullglob 2>/dev/null || true

VAULT_TASKS="$VAULT_PATH/02-Projects/TaskManager/tasks"
BACKUP_DIR="$HOME/tasks-backup-$(date +%Y%m%d-%H%M%S)"
FINFIXER_TASKS="/Users/mh/Developer/python/FinFixer/docs/tasks"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

info() { echo -e "${BLUE}Info: $*${NC}"; }
success() { echo -e "${GREEN}Success: $*${NC}"; }
warn() { echo -e "${YELLOW}Warning: $*${NC}"; }
error() { echo -e "${RED}Error: $*${NC}" >&2; }

# Create backup
create_backup() {
    info "Creating backup at: $BACKUP_DIR"
    mkdir -p "$BACKUP_DIR"
    
    # Backup existing tasks directory
    [[ -d "$VAULT_TASKS" ]] && cp -r "$VAULT_TASKS" "$BACKUP_DIR/current-tasks" 2>/dev/null || true
    
    # Backup FinFixer tasks
    [[ -d "$FINFIXER_TASKS" ]] && cp -r "$FINFIXER_TASKS" "$BACKUP_DIR/finfixer-tasks" 2>/dev/null || true
    
    success "Backup created successfully"
}

# Get next available task ID using temp counter file
get_next_task_id() {
    local counter_file="/tmp/task_migration_counter_$$"
    local max_id=0
    
    # Check if tasks directory exists and has TASK files
    if [[ -d "$VAULT_TASKS" ]]; then
        for file in "$VAULT_TASKS"/TASK-*.md; do
            # Skip if no matching files found (glob didn't expand)
            [[ -f "$file" ]] || continue
            local id=$(basename "$file" | sed -n 's/TASK-\([0-9]\+\)-.*/\1/p')
            [[ -n "$id" ]] && ((id > max_id)) && max_id=$id
        done
    fi
    
    # Initialize or read from counter file
    if [[ -f "$counter_file" ]]; then
        local counter=$(cat "$counter_file")
        max_id=$((counter > max_id ? counter : max_id))
    fi
    
    local next_id=$((max_id + 1))
    echo "$next_id" > "$counter_file"
    
    printf "%03d" $next_id
}

# Convert FinFixer task to unified format
convert_finfixer_task() {
    local source_file="$1"
    local source_dir="$2"  # active, completed, backlog
    local filename=$(basename "$source_file" .md)
    local next_id=$(get_next_task_id)
    local task_id="TASK-$next_id"
    local date=$(date +%Y-%m-%d)
    
    # Determine status from directory
    local task_status="Planned"
    case "$source_dir" in
        "active") task_status="Active" ;;
        "completed") task_status="Completed" ;;
        "backlog") task_status="Planned" ;;
    esac
    
    # Extract title from filename or use original title if available
    local title
    if [[ -f "$source_file" ]] && title=$(grep -m1 '^# ' "$source_file" | sed 's/^# //' 2>/dev/null); then
        title="$title"
    else
        title=$(echo "$filename" | sed 's/^[a-z-]*-//' | tr '-' ' ' | sed 's/\b\w/\U&/g')
    fi
    
    # Create new task file
    local target_file="$VAULT_TASKS/$task_id-$filename.md"
    
    cat > "$target_file" << EOF
---
id: $task_id
title: "$title"
status: $task_status
priority: Medium
created: $date
updated: $date
tags: [migration, finfixer]
project: "FinFixer"
---

# $task_id - $title

## Description
Migrated from FinFixer task system - see original content below for full details.

## Acceptance Criteria
- [ ] Review and update task requirements
- [ ] Verify migration accuracy
- [ ] Update task status as needed

## Progress Tracking
**Status**: $task_status - $([ "$task_status" = "Completed" ] && echo "100%" || echo "0%")

## Context
- **Original file**: $source_file
- **Original directory**: $source_dir
- **Migration date**: $date

## Progress Log
### $date
- Migrated from FinFixer task system
- Original status: $source_dir
- Preserving original context and requirements

EOF
    
    # Append original content if it exists
    if [[ -f "$source_file" ]]; then
        echo -e "\n---\n\n## Original Content\n" >> "$target_file"
        cat "$source_file" >> "$target_file"
    fi
    
    info "Migrated: $filename -> $task_id"
}

# Migrate FinFixer tasks
migrate_finfixer_tasks() {
    [[ ! -d "$FINFIXER_TASKS" ]] && { warn "FinFixer tasks directory not found: $FINFIXER_TASKS"; return; }
    
    info "Migrating FinFixer tasks..."
    
    # Migrate from each directory
    for dir in "active" "completed" "backlog"; do
        local source_dir="$FINFIXER_TASKS/$dir"
        [[ ! -d "$source_dir" ]] && continue
        
        info "Processing $dir tasks..."
        for task_file in "$source_dir"/*.md; do
            [[ -f "$task_file" ]] || continue
            [[ "$(basename "$task_file")" == "_index.md" ]] && continue
            
            convert_finfixer_task "$task_file" "$dir"
        done
    done
}

# Update gitignore for new tasks directory
update_gitignore() {
    local gitignore="$HOME/.gitignore"
    
    if [[ -f "$gitignore" ]]; then
        if ! grep -q "^!tasks/$" "$gitignore" 2>/dev/null; then
            info "Adding tasks directory to .gitignore whitelist"
            echo -e "\n# Unified task management system\n!tasks/\n!bin/task\n!bin/migrate-tasks" >> "$gitignore"
        fi
    fi
}

# Generate summary
generate_summary() {
    local task_count=$(find "$VAULT_TASKS" -name "TASK-*.md" | wc -l | tr -d ' ')
    
    cat << EOF

$GREEN==========================================
Task Migration Summary
==========================================$NC

$BLUE• Total tasks migrated: $task_count
• Backup location: $BACKUP_DIR
• Tasks directory: $VAULT_TASKS
• CLI tool: ~/bin/task$NC

$YELLOW• Next steps:
  1. Review migrated tasks: task list
  2. Update task details as needed: task update TASK-XXX
  3. Add tasks directory to dotfiles tracking
  4. Test Obsidian integration$NC

$GREEN• Migration completed successfully!$NC

EOF
}

main() {
    info "Starting task migration to unified system..."
    
    # Create backup
    create_backup
    
    # Ensure tasks directory exists
    mkdir -p "$VAULT_TASKS"
    
    # Migrate from different systems
    migrate_finfixer_tasks
    
    # Update gitignore
    update_gitignore
    
    # Regenerate task index
    if command -v ~/bin/task >/dev/null 2>&1; then
        ~/bin/task index
    fi
    
    # Generate summary
    generate_summary
    
    # Cleanup temp files
    rm -f "/tmp/task_migration_counter_$$"
}

main "$@"
