#!/bin/bash

# ============================================================================
# Start Plex Media Server, Stash, & NSFW AI Model Server with drive check
# Follows Cline Shell Guidelines: set -euo pipefail, safe expansions
# ============================================================================

set -euo pipefail

# Constants
readonly MEDIA_DRIVE_PATH="/Volumes/SoMannyFiles/Movies"
readonly STASH_CONFIG="$HOME/.stash/config.yml"
readonly AI_SERVER_LABEL="com.nsfw-ai-server"
readonly AI_SERVER_PORT="8000"

check_drive() {
    if [[ -d "$MEDIA_DRIVE_PATH" ]]; then
        echo "✓ SoMannyFiles drive is mounted"
    else
        echo "⚠ Warning: SoMannyFiles drive not found"
        echo "Movies library may not be accessible"
    fi
}

start_plex() {
    echo "Starting Plex Media Server..."
    open "/Applications/Plex Media Server.app"
    echo "Access at: http://localhost:32400/web"
}

start_stash() {
    echo "Starting Stash..."
    # Stash is configured in config.yml with nobrowser: true
    # Just verify it's running on port 9999
    if lsof -i :9999 >/dev/null 2>&1; then
        echo "✓ Stash already running on port 9999"
    else
        echo "Starting Stash in background..."
        stash --config "$STASH_CONFIG" > /dev/null 2>&1 &
        echo "Stash started (PID: $!)"
    fi
    echo "Access at: http://localhost:9999"
}

start_ai_server() {
    echo "Checking NSFW AI Model Server..."
    if lsof -i :"$AI_SERVER_PORT" >/dev/null 2>&1; then
        echo "✓ AI Model Server already running on port $AI_SERVER_PORT"
    else
        echo "AI Model Server not running (managed by launchd)"
        echo "Attempting to start via launchctl..."
        if launchctl start "$AI_SERVER_LABEL" 2>/dev/null; then
            echo "✓ AI Model Server started"
            sleep 2
        else
            echo "⚠ Warning: Could not start AI Model Server"
            echo "Check launchd status: launchctl list | grep ai-server"
        fi
    fi
    echo "Access at: http://localhost:$AI_SERVER_PORT/health"
}

main() {
    echo "=========================================="
    echo "Starting Media Stack..."
    echo "=========================================="
    check_drive
    echo ""
    start_plex
    echo ""
    start_stash
    echo ""
    start_ai_server
    echo ""
    echo "=========================================="
    echo "✓ All services started!"
    echo "=========================================="
}

main "$@"
